@model TinhNguyenXanh.DTOs.EventDTO
@{
    ViewData["Title"] = Model.Title;
    Layout = "~/Views/Shared/_Layout.cshtml";
    var relatedNews = ViewBag.RelatedNews as List<TinhNguyenXanh.Models.Event>;
}

<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">

<style>
    :root {
        --primary-color: #16a34a;
        --primary-hover: #15803d;
        --accent-light: #f0fdf4;
        --text-dark: #0f172a;
        --text-muted: #64748b;
        --border-color: #e5e7eb;
        --bg-light: #ffffff;
    }

    .event-detail-container {
        background: linear-gradient(to bottom, #f9fafb 0%, #ffffff 100%);
        min-height: 100vh;
        padding: 3rem 0;
    }

    /* Hero Section */
    .event-main-card {
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        overflow: hidden;
        margin-bottom: 2rem;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
    }

    .event-hero-image {
        width: 100%;
        height: 100%;
        min-height: 320px;
        object-fit: cover;
    }

    .event-detail-content {
        padding: 2rem;
    }

    .event-title {
        color: var(--primary-color);
        font-size: 1.8rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
        line-height: 1.3;
    }

    .event-org {
        font-size: 1rem;
        color: var(--text-muted);
        margin-bottom: 1.2rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    /* Stats Grid */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 1rem;
        margin-top: 1.5rem;
        padding-top: 1.5rem;
        border-top: 1px dashed var(--border-color);
    }

    .stat-box {
        background: var(--accent-light);
        padding: 1rem;
        border-radius: 12px;
        text-align: center;
        border: 1px solid #bbf7d0;
    }

        .stat-box i {
            font-size: 1.5rem;
            color: var(--primary-color);
            display: block;
            margin-bottom: 0.25rem;
        }

    .stat-value {
        font-weight: 700;
        color: var(--text-dark);
        font-size: 1rem;
    }

    .stat-label {
        font-size: 0.85rem;
        color: var(--text-muted);
    }

    /* Content Card */
    .content-card {
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 2rem;
        margin-bottom: 1.5rem;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.03);
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 700;
        color: var(--text-dark);
        margin-bottom: 1.25rem;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        border-left: 4px solid var(--primary-color);
        padding-left: 1rem;
    }

    /* Map */
    .map-frame {
        width: 100%;
        height: 300px;
        border-radius: 12px;
        border: 0;
        background: #eee;
    }

    /* Sidebar Register */
    .register-sidebar {
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        position: sticky;
        top: 2rem;
    }

    .btn-action {
        width: 100%;
        padding: 0.8rem;
        border-radius: 10px;
        font-weight: 600;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        transition: all 0.2s;
    }

    .btn-primary-custom {
        background: var(--primary-color);
        color: white;
        border: none;
    }

        .btn-primary-custom:hover {
            background: var(--primary-hover);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(22, 163, 74, 0.3);
        }

    .btn-outline-custom {
        background: white;
        color: var(--text-dark);
        border: 1px solid var(--border-color);
    }

        .btn-outline-custom:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

    /* Comment Section */
    .comment-list {
        max-height: 500px;
        overflow-y: auto;
    }

    .comment-item {
        border-bottom: 1px solid #f3f4f6;
        padding: 1rem 0;
    }

        .comment-item:last-child {
            border-bottom: none;
        }

    .comment-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
    }

    @@media (max-width: 991px) {
        .event-hero-image

    {
        min-height: 250px;
    }

    .stats-grid {
        grid-template-columns: repeat(2, 1fr);
    }

    }
</style>

<div class="event-detail-container">
    <div class="container">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/" class="text-decoration-none text-muted">Trang chủ</a></li>
                <li class="breadcrumb-item"><a href="/Event" class="text-decoration-none text-muted">Sự kiện</a></li>
                <li class="breadcrumb-item active" aria-current="page">Chi tiết</li>
            </ol>
        </nav>

        <div class="row g-4">
            <div class="col-lg-8">
                <div class="event-main-card">
                    <div class="row g-0 h-100">
                        <div class="col-md-5">
                            <img src="@(string.IsNullOrEmpty(Model.Images) ? "/images/default-event.png" : Model.Images)"
                                 class="event-hero-image"
                                 alt="@Model.Title"
                                 onerror="this.src='/images/default-event.png';" />
                        </div>
                        <div class="col-md-7">
                            <div class="event-detail-content h-100 d-flex flex-column justify-content-center">
                                <div class="badge bg-success bg-opacity-10 text-success mb-2 align-self-start border border-success">
                                    <i class="bi bi-tag-fill me-1"></i> @Model.CategoryName
                                </div>
                                <h1 class="event-title">@Model.Title</h1>
                                <div class="event-org">
                                    <i class="bi bi-building-fill-check text-primary"></i>
                                    <span>Tổ chức bởi: <strong>@Model.OrganizationName</strong></span>
                                </div>

                                <div class="stats-grid">
                                    <div class="stat-box">
                                        <i class="bi bi-calendar-check"></i>
                                        <div class="stat-value">@Model.StartTime.ToString("dd/MM/yyyy")</div>
                                        <div class="stat-label">Bắt đầu</div>
                                    </div>
                                    <div class="stat-box">
                                        <i class="bi bi-clock-history"></i>
                                        <div class="stat-value">@Model.StartTime.ToString("HH:mm")</div>
                                        <div class="stat-label">Giờ tập trung</div>
                                    </div>
                                    <div class="stat-box">
                                        <i class="bi bi-geo-alt"></i>
                                        <div class="stat-value text-truncate" title="@Model.Location">@Model.Location</div>
                                        <div class="stat-label">Địa điểm</div>
                                    </div>
                                    <div class="stat-box">
                                        <i class="bi bi-people"></i>
                                        <div class="stat-value">@Model.MaxVolunteers</div>
                                        <div class="stat-label">Cần tuyển</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="content-card">
                    <h5 class="section-title"><i class="bi bi-file-text"></i>Nội dung chi tiết</h5>
                    <div class="text-muted" style="line-height: 1.8;">
                        @Html.Raw(Model.Description)
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(Model.LocationCoords))
                {
                    var coords = Model.LocationCoords.Split(',');
                    if (coords.Length >= 2)
                    {
                        var mapUrl = $"https://maps.google.com/maps?q={coords[0].Trim()},{coords[1].Trim()}&hl=vi&z=15&output=embed";
                        <div class="content-card">
                            <h5 class="section-title"><i class="bi bi-map"></i>Bản đồ địa điểm</h5>
                            <iframe src="@mapUrl" class="map-frame" allowfullscreen="" loading="lazy"></iframe>
                            <p class="mt-3 mb-0 text-muted small"><i class="bi bi-geo-alt-fill me-1"></i>@Model.Location</p>
                        </div>
                    }
                }

                <div class="content-card">
                    <h5 class="section-title">
                        <i class="bi bi-chat-dots"></i>Bình luận & Hỏi đáp
                        <span class="badge bg-secondary ms-2" id="comments-count-badge">0</span>
                    </h5>

                    @if (User.Identity?.IsAuthenticated ?? false)
                    {
                        <form id="comment-form" class="mb-4 position-relative">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="EventId" value="@Model.Id" />
                            <textarea name="Content" id="comment-content" class="form-control bg-light" rows="3"
                                  placeholder="Viết bình luận của bạn..." style="border-radius: 12px; padding: 1rem;"></textarea>
                            <button type="submit" id="btn-submit-comment" class="btn btn-primary btn-sm position-absolute bottom-0 end-0 m-2 rounded-pill px-3">
                                <i class="bi bi-send-fill me-1"></i>Gửi
                            </button>
                        </form>
                    }
                    else
                    {
                        <div class="alert alert-light border text-center py-3 mb-4">
                            <a asp-area="Identity" asp-page="/Account/Login" asp-route-returnUrl="@Context.Request.Path" class="fw-bold text-primary">Đăng nhập</a> để tham gia thảo luận.
                        </div>
                    }

                    <div id="comments-list" class="comment-list">
                        <div class="text-center text-muted py-3"><div class="spinner-border spinner-border-sm text-primary" role="status"></div> Đang tải bình luận...</div>
                    </div>
                </div>
            </div>

            <div class="col-lg-4">
                <div class="register-card register-sidebar">
                    <h5 class="fw-bold mb-3">Tham gia ngay!</h5>

                    @if (TempData["Message"] != null)
                    {
                        <div class="alert alert-success small py-2"><i class="bi bi-check-circle me-1"></i>@TempData["Message"]</div>
                    }
                    @if (TempData["Error"] != null)
                    {
                        <div class="alert alert-danger small py-2"><i class="bi bi-exclamation-circle me-1"></i>@TempData["Error"]</div>
                    }

                    @if (User.Identity?.IsAuthenticated ?? false)
                    {
                        @if (ViewBag.RegistrationStatus == "Pending")
                        {
                            <div class="alert alert-warning border-warning"><i class="bi bi-hourglass-split me-2"></i>Đơn đăng ký đang chờ duyệt</div>
                        }
                        else if (ViewBag.RegistrationStatus == "Confirmed")
                        {
                            <div class="alert alert-success border-success"><i class="bi bi-check-circle-fill me-2"></i>Bạn đã là thành viên!</div>
                        }
                        else if (ViewBag.RegistrationStatus == "Rejected")
                        {
                            <div class="alert alert-danger border-danger"><i class="bi bi-x-circle-fill me-2"></i>Đơn bị từ chối</div>
                        }
                        else
                        {
                            <a asp-action="RegisterEvent" asp-route-id="@Model.Id" class="btn-action btn-primary-custom">
                                <i class="bi bi-pencil-square"></i> Đăng ký tham gia
                            </a>
                        }
                    }
                    else
                    {
                        <a asp-area="Identity" asp-page="/Account/Login" asp-route-returnUrl="@Context.Request.Path" class="btn-action btn-primary-custom">
                            <i class="bi bi-box-arrow-in-right"></i> Đăng nhập để đăng ký
                        </a>
                    }

                    <button type="button" class="btn-action btn-outline-custom text-danger border-danger mt-2" data-bs-toggle="modal" data-bs-target="#reportModal">
                        <i class="bi bi-flag-fill"></i> Báo cáo vi phạm
                    </button>

                    <hr class="my-4 text-muted">

                    <h6 class="fw-bold small text-uppercase text-muted mb-3">Tin tức liên quan</h6>
                    <div class="d-flex flex-column gap-3">
                        @if (relatedNews != null && relatedNews.Any())
                        {
                            foreach (var item in relatedNews)
                            {
                                <a href="@Url.Action("Details", "Event", new { id = item.Id })" class="text-decoration-none text-dark d-flex gap-2 align-items-center bg-light p-2 rounded-3 border">
                                    <img src="@(string.IsNullOrEmpty(item.Images) ? "/images/default-event.png" : item.Images)"
                                         class="rounded" width="60" height="60" style="object-fit:cover;"
                                         onerror="this.src='/images/default-event.png';">
                                    <div style="flex:1; min-width:0;">
                                        <div class="fw-bold small text-truncate">@item.Title</div>
                                        <div class="text-muted x-small" style="font-size:0.75rem"><i class="bi bi-calendar me-1"></i>@item.StartTime.ToString("dd/MM/yyyy")</div>
                                    </div>
                                </a>
                            }
                        }
                        else
                        {
                            <p class="text-muted small">Không có tin tức liên quan.</p>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-danger bg-opacity-10">
                <h5 class="modal-title text-danger fw-bold"><i class="bi bi-exclamation-triangle-fill me-2"></i>Báo cáo vi phạm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <p class="small text-muted mb-3">Hãy chọn lý do bạn muốn báo cáo sự kiện này. Chúng tôi sẽ xem xét trong vòng 24h.</p>
                <form id="reportForm">
                    <input type="hidden" id="reportEventId" value="@Model.Id" />
                    <div class="list-group mb-3">
                        <label class="list-group-item list-group-item-action d-flex gap-2">
                            <input class="form-check-input flex-shrink-0" type="radio" name="reasonOption" value="Lừa đảo" checked>
                            <span>Nội dung lừa đảo / Sai sự thật</span>
                        </label>
                        <label class="list-group-item list-group-item-action d-flex gap-2">
                            <input class="form-check-input flex-shrink-0" type="radio" name="reasonOption" value="Ngôn từ đả kích">
                            <span>Ngôn từ thù ghét / Không phù hợp</span>
                        </label>
                        <label class="list-group-item list-group-item-action d-flex gap-2">
                            <input class="form-check-input flex-shrink-0" type="radio" name="reasonOption" value="Spam">
                            <span>Spam / Quảng cáo rác</span>
                        </label>
                        <label class="list-group-item list-group-item-action d-flex gap-2">
                            <input class="form-check-input flex-shrink-0" type="radio" name="reasonOption" value="Khác">
                            <span>Lý do khác</span>
                        </label>
                    </div>
                    <textarea class="form-control" id="reportReasonText" rows="3" placeholder="Mô tả thêm chi tiết (nếu cần)..."></textarea>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-danger rounded-pill px-4" onclick="submitReport()">Gửi báo cáo</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script>
        // --- XỬ LÝ BÁO CÁO ---
        function submitReport() {
            const eventId = document.getElementById('reportEventId').value;
            let reason = document.querySelector('input[name="reasonOption"]:checked').value;
            const detailText = document.getElementById('reportReasonText').value.trim();

            if (reason === 'Khác' || detailText.length > 0) {
                if (reason === 'Khác' && detailText.length === 0) {
                    Swal.fire('Lưu ý', 'Vui lòng nhập chi tiết lý do.', 'warning');
                    return;
                }
                reason += (detailText ? ": " + detailText : "");
            }

            // Ẩn modal
            bootstrap.Modal.getInstance(document.getElementById('reportModal')).hide();

            // Gửi Ajax
            fetch(`/Event/Report`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `eventId=${eventId}&reason=${encodeURIComponent(reason)}`
            })
            .then(res => {
                if (res.status === 401) {
                    Swal.fire('Yêu cầu đăng nhập', 'Bạn cần đăng nhập để báo cáo.', 'info');
                    throw new Error('Unauthorized');
                }
                return res.json().then(data => ({ ok: res.ok, data }));
            })
            .then(({ ok, data }) => {
                if (ok) {
                    Swal.fire('Thành công', data.message, 'success');
                    document.getElementById('reportForm').reset();
                } else {
                    Swal.fire('Thất bại', data.message || 'Lỗi không xác định', 'error');
                }
            })
            .catch(err => {
                if(err.message !== 'Unauthorized') console.error(err);
            });
        }

        // --- XỬ LÝ BÌNH LUẬN (AJAX) ---
        (function () {
            const eventId = @Model.Id;
            const listEl = document.getElementById('comments-list');
            const badgeEl = document.getElementById('comments-count-badge');
            const formEl = document.getElementById('comment-form');
            const token = document.querySelector('input[name="__RequestVerificationToken"]')?.value;

            async function loadComments() {
                try {
                    const res = await fetch(`@Url.Action("GetComments", "Event")?eventId=${eventId}`);
                    if (res.ok) {
                        const html = await res.text();
                        listEl.innerHTML = html;
                        // Update count based on items
                        const count = listEl.querySelectorAll('.comment-item').length;
                        if(badgeEl) badgeEl.textContent = count;
                        bindDeleteButtons();
                    }
                } catch (e) {
                    listEl.innerHTML = '<div class="text-danger text-center">Lỗi tải bình luận.</div>';
                }
            }

            if (formEl) {
                formEl.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const contentEl = document.getElementById('comment-content');
                    const content = contentEl.value.trim();
                    if (!content) return;

                    const btn = document.getElementById('btn-submit-comment');
                    const originalText = btn.innerHTML;
                    btn.disabled = true;
                    btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';

                    try {
                        const formData = new FormData();
                        formData.append('EventId', eventId);
                        formData.append('Content', content);

                        const res = await fetch('@Url.Action("PostComment", "Event")', {
                            method: 'POST',
                            headers: { 'RequestVerificationToken': token },
                            body: formData
                        });

                        if (res.ok) {
                            contentEl.value = '';
                            await loadComments(); // Reload list
                        } else {
                            alert('Gửi thất bại.');
                        }
                    } catch (err) {
                        console.error(err);
                    } finally {
                        btn.disabled = false;
                        btn.innerHTML = originalText;
                    }
                });
            }

            function bindDeleteButtons() {
                document.querySelectorAll('.btn-delete-comment').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.preventDefault();
                        if(!confirm('Xóa bình luận này?')) return;

                        const id = btn.dataset.id;
                        try {
                            const res = await fetch('@Url.Action("DeleteComment", "Event")', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/x-www-form-urlencoded',
                                    'RequestVerificationToken': token
                                },
                                body: `id=${id}`
                            });
                            if(res.ok) {
                                btn.closest('.comment-item').remove();
                                if(badgeEl) badgeEl.textContent = parseInt(badgeEl.textContent) - 1;
                            }
                        } catch(err) { console.error(err); }
                    });
                });
            }

            loadComments(); // Init load
        })();
    </script>
}